<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard - CredNorth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f0f1e;
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: #1a1a2e;
            border-bottom: 1px solid #2a2a3e;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            height: 70px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .nav-brand:hover {
            opacity: 0.8;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
            align-items: center;
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            color: #b0b0c0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #2a2a3e;
            color: #ffffff;
        }

        .nav-link.active {
            background: #667eea;
            color: #ffffff;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #2a2a3e;
            border-radius: 8px;
            font-size: 14px;
        }

        .user-badge {
            background: #667eea;
            color: #ffffff;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #ef4444;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Main Content */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .header p {
            color: #a0a0b0;
            font-size: 16px;
        }

        /* Filters */
        .filters {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .filter-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .filter-btn.clear {
            background: #6b7280;
        }

        .filter-btn.clear:hover {
            background: #808897;
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
        }
        
        /* Inline Table Filters */
        .filter-row th {
            padding: 8px 10px !important;
            background: #252535 !important;
            border-bottom: 2px solid #667eea !important;
        }

        .filter-input {
            width: 100%;
            padding: 6px 8px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
            transition: all 0.3s;
        }

        .filter-input:focus {
            border-color: #667eea;
            outline: none;
            background: #252535;
        }

        .filter-input::placeholder {
            color: #6b7280;
            font-size: 11px;
        }

        .filter-range {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .filter-range input {
            width: 100%;
            padding: 6px 6px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .filter-range input:focus {
            border-color: #667eea;
            outline: none;
        }

        .filter-range span {
            color: #6b7280;
            font-size: 10px;
        }

        select.filter-input {
            cursor: pointer;
        }
        
        .active-filters {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a2a3e;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            padding: 25px;
            border-radius: 12px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .stat-card h3 {
            color: #a0a0b0;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
        }

        /* Tables Section */
        .tables-section {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-header h2 {
            color: #ffffff;
            font-size: 22px;
            font-weight: 600;
        }

        .btn-add {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        /* Tables */
        .table-scroll-wrapper {
            position: relative;
            margin-bottom: 10px;
        }

        .table-scroll-top {
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid #2a2a3e;
            border-radius: 8px 8px 0 0;
            background: #252535;
            height: 15px;
        }

        .table-scroll-top-inner {
            height: 1px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 0 0 8px 8px;
            max-width: 100%;
            border: 1px solid #2a2a3e;
            border-top: none;
        }

        table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #252535;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #e0e0e0;
            border-bottom: 2px solid #2a2a3e;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            min-width: 100px;
        }
        
        th:first-child {
            min-width: 60px;
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid #2a2a3e;
            color: #b0b0c0;
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        td:hover {
            max-width: none;
            white-space: normal;
        }

        tr:hover {
            background: #252535;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-approved {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-edit:hover {
            background: #5568d3;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #ffffff;
            font-size: 22px;
            font-weight: 600;
        }

        .close {
            color: #a0a0b0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #e0e0e0;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #252535;
            border: 2px solid #2a2a3e;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: #2a2a3e;
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 30px;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #2a2a3e;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #b0b0c0;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: #ffffff;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                height: auto;
                padding: 15px 20px;
                gap: 15px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            .container {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group select {
                width: 100%;
            }

            .table-container {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }
        }

        /* Lead Profile Modal */
        #leadProfileModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        #leadProfileModal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #leadProfileContent {
            background: #0f0f1e;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a2a3e;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-field label {
            display: block;
            color: #a0a0b0;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-field input,
        .profile-field select {
            width: 100%;
            padding: 10px 12px;
            background: #252535;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.3s;
        }

        .profile-field input:disabled,
        .profile-field select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .profile-field input:not(:disabled):focus,
        .profile-field select:not(:disabled):focus {
            border-color: #667eea;
            outline: none;
            background: #1a1a2e;
        }

        .profile-field .profile-value {
            display: block;
            padding: 10px 12px;
            background: #252535;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            word-break: break-all;
        }

        .profile-field input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .profile-field input[type="checkbox"]:disabled {
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <span>üè¶</span>
                <span>CredNorth</span>
            </a>

            <ul class="nav-menu">
                <li>
                    <a href="/" class="nav-link">
                        <span>üè†</span>
                        <span>Home</span>
                    </a>
                </li>
                <li>
                    <a href="/admin-crm-dashboard/" class="nav-link active">
                        <span>üìä</span>
                        <span>CRM Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="/depupeleadsztv/" class="nav-link">
                        <span>üîÑ</span>
                        <span>Bulk Dedupe</span>
                    </a>
                </li>
            </ul>

            <div class="nav-user">
                <div class="user-info">
                    <span>üë§</span>
                    <span>{{ request.user.username }}</span>
                    {% if request.user.is_superuser %}
                        <span class="user-badge">Admin</span>
                    {% elif request.user.is_staff %}
                        <span class="user-badge" style="background: #48bb78;">Staff</span>
                    {% endif %}
                </div>
                <a href="/logout/" class="btn-logout">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="header">
            <h1>üìä CRM Dashboard</h1>
            <p>Manage leads, disbursals, and lenders efficiently</p>
        </div>

        <!-- Filters (Only for Leads Tab) -->
        <div class="filters" id="leadsFilters" style="display: none;">
            <form method="get" id="filterForm">
                <div class="filter-actions">
                    <button type="submit" class="filter-btn">üîç Apply Filters</button>
                    <a href="/admin-crm-dashboard/" class="filter-btn clear">‚úñÔ∏è Clear</a>
                </div>
                
                <!-- Note: Actual filter inputs are integrated into the table below -->
                <div style="color: #a0a0b0; font-size: 12px; text-align: center; padding: 10px;">
                    üí° Filter inputs are located above each column in the table below
                </div>
                
                <!-- Active Filters Display -->
                {% if name_filter or phone_filter or pan_filter or email_filter or city_filter or state_filter or selected_status or selected_gender or selected_profession or income_min or income_max or pin_code or age_min or age_max or bureau_min or bureau_max %}
                <div class="active-filters">
                    <span style="color: #a0a0b0; font-size: 13px; font-weight: 600;">Active Filters:</span>
                    
                    {% if name_filter %}
                    <span class="filter-badge">üë§ Name: {{ name_filter }}</span>
                    {% endif %}
                    
                    {% if phone_filter %}
                    <span class="filter-badge">üì± Phone: {{ phone_filter }}</span>
                    {% endif %}
                    
                    {% if pan_filter %}
                    <span class="filter-badge">üÜî PAN: {{ pan_filter }}</span>
                    {% endif %}
                    
                    {% if email_filter %}
                    <span class="filter-badge">üìß Email: {{ email_filter }}</span>
                    {% endif %}
                    
                    {% if selected_gender %}
                    <span class="filter-badge">üë§ Gender: {{ selected_gender|title }}</span>
                    {% endif %}
                    
                    {% if city_filter %}
                    <span class="filter-badge">üèôÔ∏è City: {{ city_filter }}</span>
                    {% endif %}
                    
                    {% if state_filter %}
                    <span class="filter-badge">üó∫Ô∏è State: {{ state_filter }}</span>
                    {% endif %}
                    
                    {% if pin_code %}
                    <span class="filter-badge">üìç Pincode: {{ pin_code }}</span>
                    {% endif %}
                    
                    {% if selected_profession %}
                    <span class="filter-badge">üíº Profession: {{ selected_profession }}</span>
                    {% endif %}
                    
                    {% if age_min %}
                    <span class="filter-badge">üìÖ Age Min: {{ age_min }}</span>
                    {% endif %}
                    
                    {% if age_max %}
                    <span class="filter-badge">üìÖ Age Max: {{ age_max }}</span>
                    {% endif %}
                    
                    {% if income_min %}
                    <span class="filter-badge">üí∞ Income Min: ‚Çπ{{ income_min }}</span>
                    {% endif %}
                    
                    {% if income_max %}
                    <span class="filter-badge">üí∞ Income Max: ‚Çπ{{ income_max }}</span>
                    {% endif %}
                    
                    {% if bureau_min %}
                    <span class="filter-badge">üìä Bureau Min: {{ bureau_min }}</span>
                    {% endif %}
                    
                    {% if bureau_max %}
                    <span class="filter-badge">üìä Bureau Max: {{ bureau_max }}</span>
                    {% endif %}
                    
                    {% if selected_status %}
                    <span class="filter-badge">üìä Status: {{ selected_status|title }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </form>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="switchTab('leads')">üë• All Leads ({{ total_leads }})</button>
                <button class="tab-button" onclick="switchTab('disbursals')">üí∞ Disbursals ({{ total_disbursals }})</button>
                <button class="tab-button" onclick="switchTab('lenders')">üè¢ Lenders</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <!-- Statistics -->
                {% if search_query or selected_status or selected_gender or income_min or income_max or pin_code %}
                <div style="margin-bottom: 15px; padding: 10px 15px; background: #667eea15; border-left: 3px solid #667eea; border-radius: 4px;">
                    <p style="color: #667eea; font-size: 14px; font-weight: 600; margin: 0;">
                        üìä Showing filtered statistics ({{ total_leads }} leads match your filters)
                    </p>
                </div>
                {% endif %}
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">{{ total_users }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Users with Consent</h3>
                        <div class="value">{{ users_with_consent }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>High Credit Score (‚â•750)</h3>
                        <div class="value">{{ high_bureau_users }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Leads</h3>
                        <div class="value">{{ total_leads }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Approved Leads</h3>
                        <div class="value">{{ total_approved }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Disbursals</h3>
                        <div class="value">{{ total_disbursals }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Disbursed Amount</h3>
                        <div class="value">‚Çπ{{ total_disbursed_amount|floatformat:0 }}</div>
                    </div>
                </div>
            </div>

            <!-- Leads Tab -->
            <div id="leads-tab" class="tab-content">
                <div class="tables-section">
                    <div class="section-header">
                        <h2>All Leads ({{ total_leads }} total)</h2>
                        <div style="display: flex; gap: 10px;">
                            {% if total_leads > 0 %}
                            <button class="btn-add" style="background: #10b981;" onclick="exportFilteredData()">üì• Export CSV</button>
                            {% endif %}
                            <button class="btn-add" onclick="openLeadModal()">+ Add Lead</button>
                            <button class="btn-add" style="background: #f59e0b;" onclick="openBulkUploadModal()">üìÅ Bulk Upload</button>
                        </div>
                    </div>
                    <div class="table-scroll-wrapper">
                        <div class="table-scroll-top" id="topScroll">
                            <div class="table-scroll-top-inner" id="topScrollInner"></div>
                        </div>
                        <div class="table-container" id="tableContainer">
                        {% if all_leads %}
                        <form method="get" id="inlineFilterForm">
                        <table>
                            <thead>
                                <!-- Filter Row -->
                                <tr class="filter-row">
                                    <th>
                                        <button type="submit" style="width: 100%; padding: 6px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">Filter</button>
                                    </th>
                                    <th><!-- ID --></th>
                                    <th>
                                        <input type="text" name="name" class="filter-input" placeholder="Name" value="{{ name_filter }}">
                                    </th>
                                    <th>
                                        <input type="text" name="phone" class="filter-input" placeholder="Phone" value="{{ phone_filter }}">
                                    </th>
                                    <th>
                                        <input type="text" name="pan" class="filter-input" placeholder="PAN" value="{{ pan_filter }}">
                                    </th>
                                    <th>
                                        <input type="text" name="email" class="filter-input" placeholder="Email" value="{{ email_filter }}">
                                    </th>
                                    <th><!-- DOB --></th>
                                    <th>
                                        <div class="filter-range">
                                            <input type="number" name="age_min" placeholder="Min" value="{{ age_min }}">
                                            <span>-</span>
                                            <input type="number" name="age_max" placeholder="Max" value="{{ age_max }}">
                                        </div>
                                    </th>
                                    <th>
                                        <select name="gender" class="filter-input">
                                            <option value="">All</option>
                                            <option value="male" {% if selected_gender == 'male' %}selected{% endif %}>Male</option>
                                            <option value="female" {% if selected_gender == 'female' %}selected{% endif %}>Female</option>
                                            <option value="other" {% if selected_gender == 'other' %}selected{% endif %}>Other</option>
                                        </select>
                                    </th>
                                    <th>
                                        <input type="text" name="city" class="filter-input" placeholder="City" value="{{ city_filter }}">
                                    </th>
                                    <th>
                                        <input type="text" name="state" class="filter-input" placeholder="State" value="{{ state_filter }}">
                                    </th>
                                    <th>
                                        <input type="text" name="pin_code" class="filter-input" placeholder="Pincode" value="{{ pin_code }}">
                                    </th>
                                    <th>
                                        <input type="text" name="profession" class="filter-input" placeholder="Profession" value="{{ selected_profession }}">
                                    </th>
                                    <th>
                                        <div class="filter-range">
                                            <input type="number" name="income_min" placeholder="Min" value="{{ income_min }}">
                                            <span>-</span>
                                            <input type="number" name="income_max" placeholder="Max" value="{{ income_max }}">
                                        </div>
                                    </th>
                                    <th>
                                        <div class="filter-range">
                                            <input type="number" name="bureau_min" placeholder="Min" value="{{ bureau_min }}">
                                            <span>-</span>
                                            <input type="number" name="bureau_max" placeholder="Max" value="{{ bureau_max }}">
                                        </div>
                                    </th>
                                    <th>
                                        <select name="status" class="filter-input">
                                            <option value="">All</option>
                                            <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
                                            <option value="approved" {% if selected_status == 'approved' %}selected{% endif %}>Approved</option>
                                            <option value="rejected" {% if selected_status == 'rejected' %}selected{% endif %}>Rejected</option>
                                        </select>
                                    </th>
                                    <th><!-- Consent --></th>
                                    <th><!-- Data Source --></th>
                                    <th><!-- First Added --></th>
                                    <th><!-- Last Updated --></th>
                                    <th><!-- Created --></th>
                                </tr>
                                <!-- Header Row -->
                                <tr>
                                    <th>Actions</th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>PAN</th>
                                    <th>Email</th>
                                    <th>DOB</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>City</th>
                                    <th>State</th>
                                    <th>Pincode</th>
                                    <th>Profession</th>
                                    <th>Income</th>
                                    <th>Bureau Score</th>
                                    <th>Status</th>
                                    <th>Consent</th>
                                    <th>Data Source</th>
                                    <th>First Added</th>
                                    <th>Last Updated</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in all_leads %}
                        <tr>
                            <td>
                                <button type="button" class="btn-action" style="background: #667eea;" onclick="viewLeadProfile({{ lead.id }})">üëÅÔ∏è View Profile</button>
                            </td>
                            <td>{{ lead.id }}</td>
                            <td>{{ lead.first_name }} {{ lead.last_name }}</td>
                            <td>{{ lead.phone_number }}</td>
                            <td>{{ lead.pan_number }}</td>
                            <td>{{ lead.email|default:"‚Äî" }}</td>
                            <td>{{ lead.date_of_birth|date:"d/m/Y"|default:"‚Äî" }}</td>
                            <td>{{ lead.age|default:"‚Äî" }}</td>
                            <td>{{ lead.gender|default:"‚Äî" }}</td>
                            <td>{{ lead.city|default:"‚Äî" }}</td>
                            <td>{{ lead.state|default:"‚Äî" }}</td>
                            <td>{{ lead.pin_code }}</td>
                            <td>{{ lead.profession|default:"‚Äî" }}</td>
                            <td>‚Çπ{{ lead.monthly_income|floatformat:0|default:"‚Äî" }}</td>
                            <td>
                                {% if lead.bureau_score %}
                                    <span style="color: {% if lead.bureau_score >= 750 %}#10b981{% elif lead.bureau_score >= 650 %}#f59e0b{% else %}#ef4444{% endif %}; font-weight: bold;">
                                        {{ lead.bureau_score }}
                                    </span>
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ lead.status }}">
                                    {{ lead.status }}
                                </span>
                            </td>
                            <td>
                                {% if lead.consent_taken %}
                                    <span style="color: #10b981;">‚úì</span>
                                {% else %}
                                    <span style="color: #ef4444;">‚úó</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if lead.user_meta %}
                                    {{ lead.user_meta.data_source|default:"‚Äî" }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td>
                                {% if lead.user_meta and lead.user_meta.first_added_date %}
                                    {{ lead.user_meta.first_added_date|date:"d/m/Y" }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td>
                                {% if lead.user_meta and lead.user_meta.last_updated_date %}
                                    {{ lead.user_meta.last_updated_date|date:"d/m/Y" }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td>{{ lead.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </form>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No leads found</p>
                </div>
                {% endif %}
            </div>
        </div>
        </div>
    </div>

            <!-- Disbursals Tab -->
            <div id="disbursals-tab" class="tab-content">
                <div class="tables-section">
                    <div class="section-header">
                        <h2>All Disbursals ({{ total_disbursals }} total)</h2>
                        <button class="btn-add" onclick="openDisbursalModal()">+ Add Disbursal</button>
                    </div>
                    <div class="table-container">
                        {% if all_disbursals %}
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Lead Name</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Interest Rate</th>
                                    <th>Tenure</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for disbursal in all_disbursals %}
                                <tr>
                                    <td>{{ disbursal.id }}</td>
                                    <td>{{ disbursal.lead.first_name }} {{ disbursal.lead.last_name }}</td>
                                    <td>‚Çπ{{ disbursal.loan_amount|floatformat:0 }}</td>
                                    <td>{{ disbursal.disbursed_date }}</td>
                                    <td>{{ disbursal.interest_rate|default:"-" }}%</td>
                                    <td>{{ disbursal.tenure_months|default:"-" }} months</td>
                                    <td>
                                        <button class="btn-action btn-delete" onclick="deleteDisbursal({{ disbursal.id }})">Delete</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <p>No disbursals found</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Lenders Tab -->
            <div id="lenders-tab" class="tab-content">
                <div class="tables-section">
                    <div class="section-header">
                        <h2>Lenders</h2>
                        <button class="btn-add" onclick="openLenderModal()">+ Add Lender</button>
                    </div>
                    <div class="table-container">
                        {% if lenders %}
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lender in lenders %}
                                <tr>
                                    <td>{{ lender.id }}</td>
                                    <td>{{ lender.name }}</td>
                                    <td>{{ lender.contact_email|default:"-" }}</td>
                                    <td>{{ lender.contact_phone|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üè¢</div>
                            <p>No lenders found</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bulk Upload Leads (Potential Customers)</h3>
                <span class="close" onclick="closeBulkUploadModal()">&times;</span>
            </div>
            <form id="bulkUploadForm" onsubmit="validateCSV(event)">
                {% csrf_token %}
                <div style="background: #252535; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="color: #e0e0e0; margin: 0; font-size: 14px;">
                        <strong>‚ÑπÔ∏è Note:</strong> Leads are potential customers in your database. No lender association needed.
                    </p>
                </div>
                <div class="form-group">
                    <label>Upload CSV File *</label>
                    <input type="file" name="file" id="csvFile" accept=".csv" required>
                    <small style="color: #a0a0b0; display: block; margin-top: 5px;">
                        <strong>Required columns:</strong> first_name, last_name, phone_number, pan_number, pin_code<br>
                        <strong>Optional columns:</strong> date_of_birth, gender, email, city, state, monthly_income, profession, bureau_score, status, consent_taken
                    </small>
                </div>
                <div id="uploadProgress" style="display: none; padding: 10px; background: #252535; border-radius: 8px; margin-top: 10px;">
                    <div style="color: #667eea; font-weight: 600;">Validating CSV...</div>
                </div>
                <button type="submit" class="btn-submit">Validate CSV</button>
            </form>
        </div>
    </div>

    <!-- Preview and Confirm Modal -->
    <div id="previewUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bulk Upload Leads (Potential Customers)</h3>
                <span class="close" onclick="closeBulkUploadModal()">&times;</span>
            </div>
            <form id="bulkUploadForm2" onsubmit="validateCSV(event)">
                {% csrf_token %}
                <div style="background: #252535; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <p style="color: #e0e0e0; margin: 0; font-size: 14px;">
                        <strong>‚ÑπÔ∏è Note:</strong> Leads are potential customers in your database. No lender association needed.
                    </p>
                </div>
                <div class="form-group">
                    <label>Upload CSV File *</label>
                    <input type="file" name="file" id="csvFile" accept=".csv" required>
                    <small style="color: #a0a0b0; display: block; margin-top: 5px;">
                        <strong>Required columns:</strong> first_name, last_name, phone_number, pan_number, pin_code<br>
                        <strong>Optional columns:</strong> date_of_birth, gender, email, city, state, monthly_income, profession, bureau_score, status, consent_taken
                    </small>
                </div>
                <div id="uploadProgress" style="display: none; padding: 10px; background: #252535; border-radius: 8px; margin-top: 10px;">
                    <div style="color: #667eea; font-weight: 600;">Validating CSV...</div>
                </div>
                <button type="submit" class="btn-submit">Validate CSV</button>
            </form>
        </div>
    </div>

    <!-- Preview and Confirm Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>Preview and Confirm Upload</h3>
                <span class="close" onclick="closePreviewModal()">&times;</span>
            </div>
            <div id="previewContent">
                <!-- Preview will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Lead (Potential Customer)</h3>
                <span class="close" onclick="closeLeadModal()">&times;</span>
            </div>
            <form id="leadForm" onsubmit="submitLead(event)">
                {% csrf_token %}
                <div style="background: #252535; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                    <p style="color: #e0e0e0; margin: 0; font-size: 13px;">
                        <strong>‚ÑπÔ∏è Note:</strong> This is a potential customer entry. No lender association needed.
                    </p>
                </div>
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" name="first_name" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" name="last_name" required>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="text" name="phone_number" required placeholder="10 digits">
                </div>
                <div class="form-group">
                    <label>PAN *</label>
                    <input type="text" name="pan" required placeholder="AAAAA9999A">
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" name="dob">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select name="gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pin Code *</label>
                    <input type="text" name="pin_code" required placeholder="6 digits">
                </div>
                <div class="form-group">
                    <label>Monthly Income</label>
                    <input type="number" name="income" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Profession</label>
                    <select name="employment_type">
                        <option value="">Select Type</option>
                        <option value="salaried">Salaried</option>
                        <option value="self-employed">Self Employed</option>
                        <option value="business">Business</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <button type="submit" class="btn-submit">Create Lead</button>
            </form>
        </div>
    </div>

    <!-- Add Disbursal Modal -->
    <div id="disbursalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Disbursal</h3>
                <span class="close" onclick="closeDisbursalModal()">&times;</span>
            </div>
            <form id="disbursalForm" onsubmit="submitDisbursal(event)">
                {% csrf_token %}
                <div class="form-group">
                    <label>Lead *</label>
                    <select name="lead" required>
                        <option value="">Select Lead</option>
                        {% for lead in all_leads %}
                        <option value="{{ lead.id }}">{{ lead.first_name }} {{ lead.last_name }} ({{ lead.phone_number }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Loan Amount *</label>
                    <input type="number" name="loan_amount" required>
                </div>
                <div class="form-group">
                    <label>Disbursed Date *</label>
                    <input type="date" name="disbursed_date" required>
                </div>
                <div class="form-group">
                    <label>Interest Rate (%)</label>
                    <input type="number" step="0.01" name="interest_rate">
                </div>
                <div class="form-group">
                    <label>Tenure (Months)</label>
                    <input type="number" name="tenure_months">
                </div>
                <button type="submit" class="btn-submit">Create Disbursal</button>
            </form>
        </div>
    </div>

    <!-- Add Lender Modal -->
    <div id="lenderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Lender</h3>
                <span class="close" onclick="closeLenderModal()">&times;</span>
            </div>
            <form id="lenderForm" onsubmit="submitLender(event)">
                {% csrf_token %}
                <div class="form-group">
                    <label>Lender Name *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" name="contact_email">
                </div>
                <div class="form-group">
                    <label>Contact Phone</label>
                    <input type="text" name="contact_phone">
                </div>
                <button type="submit" class="btn-submit">Create Lender</button>
            </form>
        </div>
    </div>

    <!-- Lead Profile Modal -->
    <div id="leadProfileModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìã Lead Profile</h3>
                <span class="close" onclick="closeLeadProfile()">&times;</span>
            </div>
            <div id="leadProfileContent">
                <div style="text-align: center; padding: 40px; color: #a0a0b0;">
                    Loading profile...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching Function
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show the selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to the clicked tab button
            event.target.classList.add('active');
            
            // Show/hide filters based on tab
            const filtersSection = document.getElementById('leadsFilters');
            if (tabName === 'leads') {
                filtersSection.style.display = 'block';
                // Sync scrollbars after the tab is visible
                setTimeout(syncScrollbars, 100);
            } else {
                filtersSection.style.display = 'none';
            }
        }

        // Modal Functions
        function openLeadModal() {
            document.getElementById('leadModal').classList.add('active');
        }

        function closeLeadModal() {
            document.getElementById('leadModal').classList.remove('active');
            document.getElementById('leadForm').reset();
        }

        function openDisbursalModal() {
            document.getElementById('disbursalModal').classList.add('active');
        }

        function closeDisbursalModal() {
            document.getElementById('disbursalModal').classList.remove('active');
            document.getElementById('disbursalForm').reset();
        }

        function openLenderModal() {
            document.getElementById('lenderModal').classList.add('active');
        }

        function closeLenderModal() {
            document.getElementById('lenderModal').classList.remove('active');
            document.getElementById('lenderForm').reset();
        }

        // Form Submissions
        async function submitLead(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/leads/create/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Lead created successfully!');
                    closeLeadModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error creating lead');
            }
        }

        async function submitDisbursal(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/disbursals/create/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Disbursal created successfully!');
                    closeDisbursalModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error creating disbursal');
            }
        }

        async function submitLender(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/lenders/create/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Lender created successfully!');
                    closeLenderModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error creating lender');
            }
        }

        // Lead Profile Functions
        let currentLeadId = null;
        let isEditMode = false;

        async function viewLeadProfile(leadId) {
            currentLeadId = leadId;
            isEditMode = false;
            document.getElementById('leadProfileModal').classList.add('active');
            
            try {
                const response = await fetch(`/api/leads/${leadId}/`);
                const data = await response.json();
                
                if (data.success) {
                    displayLeadProfile(data.lead, data.user_meta);
                } else {
                    alert('Error loading lead profile');
                }
            } catch (error) {
                alert('Error loading lead profile');
            }
        }

        function displayLeadProfile(lead, userMeta) {
            const content = document.getElementById('leadProfileContent');
            const statusColors = {
                'pending': '#f59e0b',
                'approved': '#10b981',
                'rejected': '#ef4444'
            };
            
            let bureauColor = '#ef4444';
            if (lead.bureau_score >= 750) bureauColor = '#10b981';
            else if (lead.bureau_score >= 650) bureauColor = '#f59e0b';
            
            content.innerHTML = `
                <div style="padding: 20px;">
                    <!-- Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 25px; color: white;">
                        <h2 style="margin: 0 0 10px 0; font-size: 28px;">${lead.first_name} ${lead.last_name}</h2>
                        <p style="margin: 0; opacity: 0.9;">ID: ${lead.id} | Created: ${new Date(lead.created_at).toLocaleString()}</p>
                    </div>
                    
                    <!-- Profile Content Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        
                        <!-- Personal Information -->
                        <div style="background: #1a1a2e; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3e;">
                            <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px;">üìã Personal Information</h3>
                            <div class="profile-field">
                                <label>First Name:</label>
                                <input type="text" id="edit_first_name" value="${lead.first_name}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Last Name:</label>
                                <input type="text" id="edit_last_name" value="${lead.last_name}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Gender:</label>
                                <select id="edit_gender" disabled>
                                    <option value="">Select</option>
                                    <option value="Male" ${lead.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${lead.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${lead.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Date of Birth:</label>
                                <input type="date" id="edit_dob" value="${lead.date_of_birth}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Age:</label>
                                <span class="profile-value">${lead.age || '‚Äî'}</span>
                            </div>
                        </div>
                        
                        <!-- Contact Information -->
                        <div style="background: #1a1a2e; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3e;">
                            <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px;">üìû Contact Information</h3>
                            <div class="profile-field">
                                <label>Phone Number:</label>
                                <input type="text" id="edit_phone_number" value="${lead.phone_number}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Email:</label>
                                <input type="email" id="edit_email" value="${lead.email}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>PAN Number:</label>
                                <input type="text" id="edit_pan_number" value="${lead.pan_number}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>City:</label>
                                <input type="text" id="edit_city" value="${lead.city}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>State:</label>
                                <input type="text" id="edit_state" value="${lead.state}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Pin Code:</label>
                                <input type="text" id="edit_pin_code" value="${lead.pin_code}" disabled>
                            </div>
                        </div>
                        
                        <!-- Financial Information -->
                        <div style="background: #1a1a2e; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3e;">
                            <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px;">üí∞ Financial Information</h3>
                            <div class="profile-field">
                                <label>Profession:</label>
                                <input type="text" id="edit_profession" value="${lead.profession}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Monthly Income:</label>
                                <input type="number" id="edit_monthly_income" value="${lead.monthly_income}" disabled>
                            </div>
                            <div class="profile-field">
                                <label>Bureau Score:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="edit_bureau_score" value="${lead.bureau_score || ''}" disabled style="flex: 1;">
                                    ${lead.bureau_score ? `<span style="color: ${bureauColor}; font-weight: bold; font-size: 18px;">${lead.bureau_score}</span>` : ''}
                                </div>
                            </div>
                            <div class="profile-field">
                                <label>Status:</label>
                                <select id="edit_status" disabled>
                                    <option value="pending" ${lead.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="approved" ${lead.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${lead.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                            </div>
                            <div class="profile-field">
                                <label>Consent Taken:</label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="edit_consent" ${lead.consent_taken ? 'checked' : ''} disabled>
                                    <span>${lead.consent_taken ? 'Yes' : 'No'}</span>
                                </label>
                            </div>
                        </div>
                        
                        ${userMeta ? `
                        <!-- Meta Information -->
                        <div style="background: #1a1a2e; padding: 20px; border-radius: 12px; border: 1px solid #2a2a3e;">
                            <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 18px;">‚ÑπÔ∏è Meta Information</h3>
                            <div class="profile-field">
                                <label>Data Source:</label>
                                <span class="profile-value">${userMeta.data_source || '‚Äî'}</span>
                            </div>
                            <div class="profile-field">
                                <label>First Added:</label>
                                <span class="profile-value">${userMeta.first_added_date}</span>
                            </div>
                            <div class="profile-field">
                                <label>Last Updated:</label>
                                <span class="profile-value">${userMeta.last_updated_date}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #2a2a3e;">
                        <button class="btn-submit" style="background: #6b7280;" onclick="closeLeadProfile()">Close</button>
                        <button id="editButton" class="btn-submit" style="background: #667eea;" onclick="toggleEditMode()">‚úèÔ∏è Edit</button>
                        <button id="saveButton" class="btn-submit" style="background: #10b981; display: none;" onclick="saveLeadProfile()">üíæ Save Changes</button>
                        <button id="cancelButton" class="btn-submit" style="background: #6b7280; display: none;" onclick="cancelEdit()">Cancel</button>
                        <button class="btn-submit" style="background: #ef4444;" onclick="deleteLeadFromProfile()">üóëÔ∏è Delete Lead</button>
                    </div>
                </div>
            `;
        }

        function toggleEditMode() {
            isEditMode = true;
            
            // Enable input fields
            document.getElementById('edit_first_name').disabled = false;
            document.getElementById('edit_last_name').disabled = false;
            document.getElementById('edit_phone_number').disabled = false;
            document.getElementById('edit_email').disabled = false;
            document.getElementById('edit_pan_number').disabled = false;
            document.getElementById('edit_gender').disabled = false;
            document.getElementById('edit_dob').disabled = false;
            document.getElementById('edit_city').disabled = false;
            document.getElementById('edit_state').disabled = false;
            document.getElementById('edit_pin_code').disabled = false;
            document.getElementById('edit_profession').disabled = false;
            document.getElementById('edit_monthly_income').disabled = false;
            document.getElementById('edit_bureau_score').disabled = false;
            document.getElementById('edit_status').disabled = false;
            document.getElementById('edit_consent').disabled = false;
            
            // Toggle buttons
            document.getElementById('editButton').style.display = 'none';
            document.getElementById('saveButton').style.display = 'block';
            document.getElementById('cancelButton').style.display = 'block';
        }

        function cancelEdit() {
            // Reload profile to reset fields
            viewLeadProfile(currentLeadId);
        }

        async function saveLeadProfile() {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('first_name', document.getElementById('edit_first_name').value);
            formData.append('last_name', document.getElementById('edit_last_name').value);
            formData.append('phone_number', document.getElementById('edit_phone_number').value);
            formData.append('email', document.getElementById('edit_email').value);
            formData.append('pan_number', document.getElementById('edit_pan_number').value);
            formData.append('gender', document.getElementById('edit_gender').value);
            formData.append('date_of_birth', document.getElementById('edit_dob').value);
            formData.append('city', document.getElementById('edit_city').value);
            formData.append('state', document.getElementById('edit_state').value);
            formData.append('pin_code', document.getElementById('edit_pin_code').value);
            formData.append('profession', document.getElementById('edit_profession').value);
            formData.append('monthly_income', document.getElementById('edit_monthly_income').value);
            formData.append('bureau_score', document.getElementById('edit_bureau_score').value);
            formData.append('status', document.getElementById('edit_status').value);
            formData.append('consent_taken', document.getElementById('edit_consent').checked);
            
            try {
                const response = await fetch(`/api/leads/${currentLeadId}/update/`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Lead updated successfully!');
                    closeLeadProfile();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error updating lead');
            }
        }

        async function deleteLeadFromProfile() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this lead? This action cannot be undone.')) return;
            
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            try {
                const response = await fetch(`/api/leads/${currentLeadId}/delete/`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    closeLeadProfile();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting lead');
            }
        }

        function closeLeadProfile() {
            document.getElementById('leadProfileModal').classList.remove('active');
            currentLeadId = null;
            isEditMode = false;
        }

        // Delete Functions
        async function deleteLead(leadId) {
            if (!confirm('Are you sure you want to delete this lead?')) return;
            
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            try {
                const response = await fetch(`/api/leads/${leadId}/delete/`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Lead deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting lead');
            }
        }

        async function deleteDisbursal(disbursalId) {
            if (!confirm('Are you sure you want to delete this disbursal?')) return;
            
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            try {
                const response = await fetch(`/api/disbursals/${disbursalId}/delete/`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Disbursal deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting disbursal');
            }
        }

        // Bulk Upload Functions
        function openBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.add('active');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.remove('active');
            document.getElementById('bulkUploadForm').reset();
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
            document.getElementById('previewContent').innerHTML = '';
        }

        async function validateCSV(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = '<div style="color: #667eea; font-weight: 600;">Validating CSV...</div>';
            
            try {
                const response = await fetch('/api/leads/validate-csv/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    showPreview(data);
                    closeBulkUploadModal();
                } else {
                    // Show detailed error message
                    let errorMsg = 'CSV Validation Error:\n\n';
                    errorMsg += data.error || 'Unknown error';
                    
                    if (data.errors && data.errors.length > 0) {
                        errorMsg += '\n\nDetails:\n';
                        errorMsg += data.errors.slice(0, 10).join('\n');
                        if (data.errors.length > 10) {
                            errorMsg += `\n... and ${data.errors.length - 10} more errors`;
                        }
                    }
                    
                    alert(errorMsg);
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                console.error('Validation error:', error);
                alert('Error validating CSV. Please check the console for details.\n\nError: ' + error.message);
            }
        }

        function showPreview(data) {
            const previewContent = document.getElementById('previewContent');
            
            let html = '';
            
            if (data.errors && data.errors.length > 0) {
                html += '<div style="background: #7f1d1d; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 10px; color: #fca5a5;">‚ö†Ô∏è Validation Warnings:</h4>';
                html += '<ul style="padding-left: 20px; color: #fca5a5;">';
                data.errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += `<div style="margin-bottom: 20px;">
                <p style="color: #a0a0b0;">Found <strong style="color: #48bb78;">${data.total_rows}</strong> valid rows in the CSV.</p>
                <p style="color: #a0a0b0;">Lender: <strong style="color: #667eea;">${data.lender_name}</strong></p>
            </div>`;
            
            html += '<div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #252535;">';
            html += '<th style="padding: 10px; border: 1px solid #2a2a3e;">First Name</th>';
            html += '<th style="padding: 10px; border: 1px solid #2a2a3e;">Last Name</th>';
            html += '<th style="padding: 10px; border: 1px solid #2a2a3e;">Phone</th>';
            html += '<th style="padding: 10px; border: 1px solid #2a2a3e;">PAN</th>';
            html += '<th style="padding: 10px; border: 1px solid #2a2a3e;">Income</th>';
            html += '</tr></thead><tbody>';
            
            data.preview_rows.forEach(row => {
                html += '<tr>';
                html += `<td style="padding: 8px; border: 1px solid #2a2a3e;">${row.first_name}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #2a2a3e;">${row.last_name}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #2a2a3e;">${row.phone_number}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #2a2a3e;">${row.pan_number}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #2a2a3e;">‚Çπ${row.monthly_income}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            html += '<div style="display: flex; gap: 10px;">';
            html += `<button class="btn-submit" onclick="confirmUpload('${data.session_id}')">‚úì Confirm and Upload</button>`;
            html += '<button class="btn-submit" style="background: #6b7280;" onclick="closePreviewModal()">Cancel</button>';
            html += '</div>';
            
            previewContent.innerHTML = html;
            document.getElementById('previewModal').classList.add('active');
        }

        async function confirmUpload(sessionId) {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('session_id', sessionId);
            
            try {
                const response = await fetch('/api/leads/bulk-upload/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = `Successfully uploaded ${data.created_count} leads!`;
                    if (data.message) {
                        message = data.message;
                    }
                    alert(message);
                    closePreviewModal();
                    location.reload();
                } else {
                    alert('Error uploading leads: ' + data.error);
                }
            } catch (error) {
                alert('Error uploading leads');
            }
        }

        // Export filtered data
        function exportFilteredData() {
            const params = new URLSearchParams(window.location.search);
            params.append('export', 'csv');
            window.location.href = '/api/leads/export/?' + params.toString();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Synchronize top and bottom scrollbars
        let scrollSyncInitialized = false;
        
        function syncScrollbars() {
            const topScroll = document.getElementById('topScroll');
            const tableContainer = document.getElementById('tableContainer');
            const topScrollInner = document.getElementById('topScrollInner');
            
            if (!topScroll || !tableContainer || !topScrollInner) {
                console.log('Scrollbar elements not found');
                return;
            }
            
            // Set the width of the inner div to match the table width
            const table = tableContainer.querySelector('table');
            if (table) {
                const tableWidth = table.scrollWidth;
                console.log('Table scroll width:', tableWidth);
                topScrollInner.style.width = tableWidth + 'px';
            } else {
                console.log('Table not found');
                return;
            }
            
            // Only add listeners once
            if (!scrollSyncInitialized) {
                // Sync top scroll to bottom scroll
                topScroll.addEventListener('scroll', function() {
                    if (!topScroll.isSyncing) {
                        tableContainer.isSyncing = true;
                        tableContainer.scrollLeft = topScroll.scrollLeft;
                        setTimeout(() => { tableContainer.isSyncing = false; }, 10);
                    }
                });
                
                // Sync bottom scroll to top scroll
                tableContainer.addEventListener('scroll', function() {
                    if (!tableContainer.isSyncing) {
                        topScroll.isSyncing = true;
                        topScroll.scrollLeft = tableContainer.scrollLeft;
                        setTimeout(() => { topScroll.isSyncing = false; }, 10);
                    }
                });
                
                scrollSyncInitialized = true;
                console.log('Scrollbars synchronized');
            } else {
                console.log('Scrollbar width updated');
            }
        }

        // Check if there are filter parameters in the URL and switch to leads tab
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const filterParams = ['name', 'phone', 'pan', 'email', 'gender', 'city', 'state', 'pin_code', 
                                  'profession', 'status', 'income_min', 'income_max', 'age_min', 'age_max', 
                                  'bureau_min', 'bureau_max', 'search'];
            
            // Check if any filter parameter exists
            const hasFilters = filterParams.some(param => urlParams.has(param) && urlParams.get(param) !== '');
            
            if (hasFilters) {
                // Switch to leads tab
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                // Activate leads tab
                document.getElementById('leads-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active'); // Second button is leads
                
                // Show filters
                document.getElementById('leadsFilters').style.display = 'block';
                
                // Initialize scrollbar sync after a short delay to ensure table is rendered
                setTimeout(syncScrollbars, 100);
            }
        });
    </script>
</body>
</html>
